#!/bin/bash

# Formigio WIP - First Time Setup Script
# This script sets up the wip-scaffold-personal as a shared WIP within your main WIP,
# allowing you to contribute improvements back to the scaffold while maintaining
# your own personal WIP workspace.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCAFFOLD_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SCAFFOLD_NAME="$(basename "$SCAFFOLD_ROOT")"

echo "ðŸš€ Formigio WIP - First Time Setup"
echo ""
echo "This script will set up your Personal WIP workspace."
echo ""

# Detect if we're in a shared/ directory structure (already part of main WIP)
if [[ "$SCAFFOLD_ROOT" == */shared/* ]]; then
    echo "âœ… Detected shared WIP structure"
    echo "   Location: $SCAFFOLD_ROOT"
    echo ""
    echo "The scaffold is already set up as a shared WIP."
    echo "You can contribute improvements back to the scaffold repo!"
    echo ""
else
    echo "ðŸ“¦ Setting up standalone Personal WIP"
    echo "   Location: $SCAFFOLD_ROOT"
    echo ""

    # Check if git is already initialized
    if [ -d "$SCAFFOLD_ROOT/.git" ]; then
        REMOTE_URL=$(git -C "$SCAFFOLD_ROOT" remote get-url origin 2>/dev/null || echo "")

        if [[ "$REMOTE_URL" == *"wip-scaffold-personal"* ]]; then
            echo "ðŸ”§ Disconnecting from scaffold repository..."
            git -C "$SCAFFOLD_ROOT" remote remove origin
            echo "âœ… Removed scaffold remote - your personal WIP is now independent"
            echo ""
            echo "Your personal data will not be pushed to the scaffold repo."
            echo ""
            echo "To set up your own remote for backup:"
            echo "  1. Create a new private GitHub repository"
            echo "  2. Run: git remote add origin <your-repo-url>"
            echo "  3. Run: git push -u origin main"
            echo ""
        else
            echo "âœ… Git already initialized with custom remote"
            echo ""
        fi
    else
        echo "ðŸ“¦ Initializing git repository..."
        git -C "$SCAFFOLD_ROOT" init
        git -C "$SCAFFOLD_ROOT" add .
        git -C "$SCAFFOLD_ROOT" commit -m "Initial commit: Personal WIP setup"

        echo "âœ… Git repository initialized!"
        echo ""
        echo "To set up a remote for backup:"
        echo "  1. Create a new private GitHub repository"
        echo "  2. Run: git remote add origin <your-repo-url>"
        echo "  3. Run: git push -u origin main"
        echo ""
    fi
fi

# Make sure wip script is executable
chmod +x "$SCAFFOLD_ROOT/bin/wip"

echo "ðŸŽ‰ Setup complete!"
echo ""
echo "Your Personal WIP is ready to use!"
echo ""
echo "Next steps:"
echo "1. Customize your recurring-tasks.md"
echo "2. Start your first day with: ./bin/wip new-day"
echo "3. Or ask Claude Code to help you plan your day"
echo ""
echo "Note: The .me identity file will be created automatically when you"
echo "      work with shared Team WIPs (it's gitignored)."
echo ""
echo "Your personal WIP is now independent from the scaffold."
echo "Consider setting up a private git remote for backup!"
echo ""
echo "For help, see README.md or ask Claude Code!"
